# 脉冲序列重复启动功能测试说明

## 功能概述

当脉冲序列参数设置完成后，支持多次启动脉冲输出，每次都使用相同的参数进行输出。

## 实现原理

1. **参数保持**：脉冲序列参数（`g_seq_buf`、`g_expected_num_of_group`等）在输出完成后不会被清除
2. **状态管理**：
   - 输出完成后，状态从`RUNNING`切换到`IDLE`
   - `pulse_engine_start()`只检查是否正在运行，`IDLE`状态可以重新启动
3. **计数器管理**：
   - **正常模式**：每次启动时`g_output_count`重置为0
   - **心电同步模式**：按照`repeat_count`累加计数

## 测试步骤

### 测试场景1：正常模式重复启动

```
步骤1: 设置正常模式
       命令: 0x32, 数据: 0x00

步骤2: 设置第1群参数
       命令: 0x34
       数据: [num_of_group=2, group_num=1, ...]

步骤3: 设置第2群参数
       命令: 0x34
       数据: [num_of_group=2, group_num=2, ...]

步骤4: 第一次启动
       命令: 0x30, 数据: 0x01
       期望: 返回ACK_OK，开始输出

步骤5: 等待输出完成
       观察: 自动上报状态 "Normal|OK|1"

步骤6: 第二次启动（使用相同参数）
       命令: 0x30, 数据: 0x01
       期望: 返回ACK_OK，再次开始输出

步骤7: 等待输出完成
       观察: 再次上报状态 "Normal|OK|1"（计数重置为1）

步骤8: 第三次启动
       命令: 0x30, 数据: 0x01
       期望: 继续成功启动
```

### 测试场景2：修改参数后重新启动

```
步骤1-7: 同上（完成两次输出）

步骤8: 设置新的第1群参数（group_num=1会触发清除）
       命令: 0x34
       数据: [num_of_group=1, group_num=1, ...]（新参数）

步骤9: 启动（使用新参数）
       命令: 0x30, 数据: 0x01
       期望: 使用新参数输出
```

### 测试场景3：心电同步模式

```
步骤1: 设置心电同步模式
       命令: 0x32, 数据: 0x01

步骤2: 设置心电同步参数
       命令: 0x36
       数据: [fire_on_r_index=3, trigger_delay_ms=100, repeat_count=5]

步骤3-4: 设置脉冲序列参数（同场景1）

步骤5: 启动
       命令: 0x30, 数据: 0x01
       期望: 等待心电触发

步骤6-10: 触发5次R波，每次完成后上报
       观察: "SYNC|OK|1", "SYNC|OK|2", ..., "SYNC|OK|5"

步骤11: 第二次启动（重复整个过程）
       命令: 0x30, 数据: 0x01
       期望: 计数重置，再次等待心电触发
```

## 关键代码修改点

### 1. pulse_engine_start() - 支持重复启动

```c
int pulse_engine_start(void)
{
    /* 检查参数是否完整 */
    if (g_group_num != g_expected_num_of_group) {
        return -1;
    }
    
    /* 检查是否正在运行（IDLE状态可以启动） */
    if (g_pulse_status == PULSE_STATUS_RUNNING) {
        return -1;
    }
    
    /* 正常模式：重置计数，支持重复启动 */
    if (g_pulse_mode == PULSE_MODE_NORMAL) {
        g_output_count = 0;  // 每次启动重置
        // ... 启动硬件
    }
    
    return 0;
}
```

### 2. pulse_engine_set_seq_param() - 支持参数更新

```c
int pulse_engine_set_seq_param(const pulse_params_t* p)
{
    /* 如果是第一个群参数，清除旧参数 */
    if (p->group_num == 1) {
        g_group_num = 0;
        g_expected_num_of_group = p->num_of_group;
        g_expected_group_num = 1;
        memset(g_seq_buf, 0, sizeof(g_seq_buf));
    }
    
    // ... 保存参数
}
```

### 3. HRTIM1_TIMB_IRQHandler() - 输出完成处理

```c
void HRTIM1_TIMB_IRQHandler(void)
{
    if (g_group_cnt >= g_group_num) {
        /* 所有群输出完成 */
        g_group_cnt = 0;
        pulse_engine_notify_output_complete();
        g_pulse_status = PULSE_STATUS_IDLE;  // 切换到空闲，允许重新启动
    }
}
```

## 测试帧示例

使用提供的HTML工具生成测试帧：

1. **设置正常模式**: `FA 0A 00 03 32 02 00 85 32 0D`
2. **启动脉冲**: `FA 0A 00 03 30 02 01 85 31 0D`
3. **停止脉冲**: `FA 0A 00 03 30 02 00 44 F1 0D`
4. **获取状态**: `FA 09 00 03 31 02 85 C2 0D`

## 预期结果

1. ✅ 参数设置完成后可以多次启动
2. ✅ 每次启动都使用相同的参数
3. ✅ 正常模式下计数每次重置为1
4. ✅ 心电同步模式下计数累加
5. ✅ 设置group_num=1的参数时清除旧参数
6. ✅ 运行中不能启动新的输出

## 常见错误处理

| 错误场景 | 返回码 | 说明 |
|---------|--------|------|
| 参数未设置完整 | -1 | g_group_num != g_expected_num_of_group |
| 正在运行时启动 | -1 | g_pulse_status == RUNNING |
| 参数无效 | ACK_ERR_DATA_INVALID_PARAM | 参数超出范围 |
| 硬件配置失败 | -1 | pulse_out_set_hardware() 失败 |

## 日志输出示例

```
[SLAVE] Pulse engine started
[SLAVE] Upload pulse status: Normal|OK|1
[SLAVE] Pulse engine started      // 第二次启动
[SLAVE] Upload pulse status: Normal|OK|1
```

## 注意事项

1. 重复启动前应等待上一次输出完全完成（状态为IDLE）
2. 如需使用新参数，从group_num=1开始重新设置
3. 心电同步模式下注意repeat_count的设置
4. 建议每次启动前查询状态，确认不在RUNNING状态

