# 脉冲序列重复启动功能实现总结

## 📋 功能需求

实现脉冲序列参数设置完成后，支持多次发送`CMD_CTRL_PULSE_ENGINE_START`命令，每次都使用相同的参数进行脉冲序列输出。

## ✅ 实现方案

### 1. 参数持久化机制

**修改文件**: `modules/pulse_engine.c`

**关键变量保持**:
```c
/* 这些变量在输出完成后不会被清除 */
static pulse_params_t g_seq_buf[GROUP_NUM_MAX];     // 脉冲序列参数
static uint8_t g_expected_num_of_group;              // 总群数
static uint8_t g_group_num;                          // 已设置的群数
static uint16_t g_group_gap_ms;                      // 群间隙
static pulse_mode_t g_pulse_mode;                    // 输出模式
static ecg_sync_cfg_t g_ecg_sync_cfg;               // 心电同步参数
```

### 2. 状态管理优化

**状态流转**:
```
设置参数 → IDLE → 启动(start) → RUNNING → 完成 → IDLE → 再次启动...
                      ↑                               ↓
                      └─────────────重复启动──────────┘
```

**代码实现**:
```c
int pulse_engine_start(void)
{
    /* 只检查是否正在运行，IDLE/COMPLETED状态都可以启动 */
    if (g_pulse_status == PULSE_STATUS_RUNNING) {
        return -1;  // 运行中不能重复启动
    }
    
    /* 正常模式：每次启动重置计数 */
    if (g_pulse_mode == PULSE_MODE_NORMAL) {
        g_output_count = 0;
        // ... 启动硬件
    }
    
    return 0;
}
```

### 3. 参数更新机制

**智能参数清除**: 当接收到`group_num=1`时自动清除旧参数

**代码实现**:
```c
int pulse_engine_set_seq_param(const pulse_params_t* p)
{
    /* group_num=1 触发参数重置 */
    if (p->group_num == 1) {
        g_group_num = 0;
        g_expected_num_of_group = p->num_of_group;
        g_expected_group_num = 1;
        memset(g_seq_buf, 0, sizeof(g_seq_buf));
    }
    
    /* 顺序检查并保存 */
    if (p->group_num != g_expected_group_num) {
        return -1;
    }
    
    memcpy(&g_seq_buf[g_group_num], p, sizeof(pulse_params_t));
    g_group_num++;
    g_expected_group_num++;
    
    return 0;
}
```

### 4. 输出完成处理

**中断处理**:
```c
void HRTIM1_TIMB_IRQHandler(void)
{
    if (所有群输出完成) {
        g_group_cnt = 0;                    // 重置群计数
        pulse_engine_notify_output_complete(); // 通知完成，计数+1
        g_pulse_status = PULSE_STATUS_IDLE;    // 切换到空闲状态
        // 参数不清除，保留供下次启动使用
    }
}
```

## 📊 功能特性对比

| 特性 | 之前 | 现在 |
|------|------|------|
| 参数保持 | ❌ 输出后可能丢失 | ✅ 持久保存 |
| 重复启动 | ❌ 需重新设置参数 | ✅ 直接启动 |
| 参数更新 | ⚠️ 需手动清除 | ✅ 自动检测清除 |
| 状态管理 | ⚠️ 不明确 | ✅ 清晰的状态机 |
| 计数管理 | ❓ 不确定 | ✅ 模式化管理 |

## 🎯 使用场景

### 场景1: 重复测试相同参数
```
1. 设置参数（群1、群2）
2. 启动输出 → 完成
3. 直接再次启动 → 完成（无需重新设置参数）
4. 多次重复步骤3
```

### 场景2: 更新参数后输出
```
1. 设置参数A（群1、群2）
2. 启动输出 → 完成
3. 设置新参数B（从群1开始，自动清除参数A）
4. 启动输出 → 使用参数B
```

### 场景3: 心电同步多次触发
```
1. 设置心电同步模式，repeat_count=5
2. 设置脉冲序列参数
3. 启动 → 等待5次R波触发 → 完成
4. 再次启动 → 重新等待5次R波触发
```

## 🔧 关键代码修改

### 文件1: modules/pulse_engine.c

**修改点1**: 启动函数支持重复启动
```c
// 第510行
g_output_count = 0;  // 正常模式每次启动重置计数
```

**修改点2**: 参数设置支持自动清除
```c
// 第192-198行
if (p->group_num == 1) {
    g_group_num = 0;
    g_expected_num_of_group = p->num_of_group;
    g_expected_group_num = 1;
    g_group_gap_ms = p->group_gap;
    memset(g_seq_buf, 0, sizeof(g_seq_buf));
}
```

**修改点3**: 中断处理保持参数
```c
// 第638-648行
g_group_cnt = 0;  // 只重置群计数
pulse_engine_notify_output_complete();
g_pulse_status = PULSE_STATUS_IDLE;  // 切换到空闲，允许重启
// 注意：g_seq_buf等参数不清除
```

### 文件2: applications/custom_slave.c

**无需修改**: 控制命令处理函数已经支持，无需额外修改。

## 📝 测试验证

### 测试用例1: 基本重复启动
```
✅ 步骤1: 设置2群参数
✅ 步骤2: 第1次启动 → 成功输出
✅ 步骤3: 第2次启动 → 成功输出（使用相同参数）
✅ 步骤4: 第3次启动 → 成功输出
```

### 测试用例2: 运行中重复启动（应失败）
```
✅ 步骤1: 设置参数并启动
✅ 步骤2: 运行中再次发送启动命令
✅ 预期: 返回错误（ACK_ERR_OPERATE_ABNORMAL）
```

### 测试用例3: 参数更新
```
✅ 步骤1: 设置参数A（2群）并启动
✅ 步骤2: 完成后设置新参数B（group_num=1，触发清除）
✅ 步骤3: 启动 → 使用新参数B输出
```

## 🎨 状态转换图

```
           设置参数
              ↓
         [IDLE状态]
              ↓
         发送启动命令
              ↓
        [RUNNING状态]
              ↓
         脉冲序列输出
              ↓
         所有群完成
              ↓
    通知完成 & 状态上报
              ↓
         [IDLE状态] ←──┐
              ↓         │
         再次启动命令   │
              ↓         │
        [RUNNING状态]   │
              ↓         │
         重复输出       │
              ↓         │
         完成 ──────────┘
```

## 📌 注意事项

1. **并发保护**: 运行中不允许重复启动（返回错误）
2. **参数完整性**: 启动前检查`g_group_num == g_expected_num_of_group`
3. **模式区分**: 
   - 正常模式：每次启动重置计数为0
   - 心电同步模式：按repeat_count累加
4. **参数更新**: group_num=1自动触发参数清除
5. **状态查询**: 建议启动前查询状态，确保不在RUNNING

## 🚀 性能优化

1. ✅ 避免重复设置参数，提高效率
2. ✅ 参数缓存在RAM中，启动速度快
3. ✅ 清晰的状态管理，减少错误
4. ✅ 支持快速连续测试

## 📖 相关文档

- `测试说明_重复启动.md` - 详细测试步骤和用例
- `protocol_frame_generator.html` - 测试帧生成工具
- `pulse_engine.h` - 函数接口定义
- `pulse_engine.c` - 核心实现

## ✨ 总结

通过以上修改，完整实现了脉冲序列重复启动功能：

✅ **参数持久化**: 输出完成后参数保持不变  
✅ **智能状态管理**: 清晰的状态流转  
✅ **灵活参数更新**: 自动检测并清除旧参数  
✅ **模式化计数**: 正常模式和心电同步模式分别处理  
✅ **易用性**: 无需重复设置参数，直接启动即可  

该功能大大简化了测试流程，提高了系统的易用性和可靠性。

