# 心电同步触发定时器重构说明

## 重构目标

将心电同步触发相关的定时任务从单一TIM6分离到三个独立的定时器，并在设置参数时预配置定时器。

## 定时器分配

### 重构前
- **TIM6**：群间隙定时器 + 触发延时定时器 + 停止时间定时器（复用，需要动态配置）

### 重构后
- **TIM6**：群间隙定时器（正常模式和心电同步模式）
- **TIM7**：触发延时定时器（仅心电同步模式）
- **TIM15**：停止时间定时器（仅心电同步模式）

## 主要修改

### 1. 定时器配置函数修改

#### `config_delay_timer()` - 配置TIM7
```c
// 修改前：配置TIM6
__HAL_TIM_SET_PRESCALER(&htim6, psc);

// 修改后：配置TIM7
__HAL_TIM_SET_PRESCALER(&htim7, psc);
```

#### `config_stop_time_timer()` - 配置TIM15
```c
// 修改前：配置TIM6
__HAL_TIM_SET_PRESCALER(&htim6, psc);

// 修改后：配置TIM15
__HAL_TIM_SET_PRESCALER(&htim15, psc);
```

### 2. 参数设置时预配置定时器

**位置**：`pulse_engine_set_sync_param()`

```c
int32_t pulse_engine_set_sync_param(const ecg_sync_cfg_t* config)
{
    // ... 参数验证 ...
    
    if (g_control.status != PULSE_STATUS_RUNNING) {
        (void)memcpy((void *)&g_ecg_sync.cfg, config, sizeof(ecg_sync_cfg_t));
        
        /* 【新增】配置触发延时定时器（TIM7） */
        config_delay_timer(config->trigger_delay_ms);
        
        /* 【新增】配置停止时间定时器（TIM15） */
        config_stop_time_timer(config->stop_delay_ms);
        
        result = 0;
    }
}
```

**优势**：
- ✅ 参数设置时一次性配置好，运行时只需启动/停止
- ✅ 减少运行时配置开销
- ✅ 避免运行时配置错误

### 3. R波捕获回调修改

#### 检测到触发R波时
```c
case SYNC_STATUS_WAIT_R_TRIGGER:
    g_ecg_sync.state = SYNC_STATUS_WAIT_DELAY;
    __HAL_TIM_DISABLE(&htim4);
    
    /* 【修改】直接启动TIM7（已在设置参数时配置好） */
    __HAL_TIM_SET_COUNTER(&htim7, 0U);
    __HAL_TIM_ENABLE(&htim7);
    break;
```

#### 间隔满足再次触发时
```c
case SYNC_STATUS_WAIT_INTERVAL:
    if (条件满足 && 还有重复次数) {
        g_ecg_sync.state = SYNC_STATUS_WAIT_DELAY;
        __HAL_TIM_DISABLE(&htim4);
        
        /* 【修改】直接启动TIM7（已在设置参数时配置好） */
        __HAL_TIM_SET_COUNTER(&htim7, 0U);
        __HAL_TIM_ENABLE(&htim7);
    }
    break;
```

### 4. 脉冲完成处理修改

```c
if (g_ecg_sync.state == SYNC_STATUS_PULSING) {
    g_ecg_sync.state = SYNC_STATUS_STOP_TIME;
    g_ecg_sync.r_cnt_stop = 0U;
    
    /* 重新启动输入捕获中断 */
    __HAL_TIM_CLEAR_FLAG(&htim4, TIM_FLAG_CC1);
    __HAL_TIM_ENABLE_IT(&htim4, TIM_IT_CC1);
    __HAL_TIM_ENABLE(&htim4);
    
    /* 【修改】直接启动TIM15（已在设置参数时配置好） */
    __HAL_TIM_SET_COUNTER(&htim15, 0U);
    __HAL_TIM_ENABLE(&htim15);
}
```

### 5. 定时器中断回调修改

**位置**：`HAL_TIM_PeriodElapsedCallback()`

```c
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
    if (htim->Instance == TIM6) {
        /* 群间隙定时器超时 */
        start_pulse_output();
        __HAL_TIM_DISABLE(&htim6);
    } else if (htim->Instance == TIM7) {
        /* 触发延时到达，启动脉冲输出 */
        __HAL_TIM_DISABLE(&htim7);
        g_ecg_sync.state = SYNC_STATUS_PULSING;
        start_pulse_internal();
    } else if (htim->Instance == TIM15) {
        /* 停止时间结束，进入等待间隔状态 */
        __HAL_TIM_DISABLE(&htim15);  // 【修复】之前错误地禁用了TIM6
        g_ecg_sync.state = SYNC_STATUS_WAIT_INTERVAL;
        
        /* 检查间隔条件 */
        if (g_ecg_sync.r_cnt_stop >= g_ecg_sync.cfg.interval_R) {
            go_wait_r_trigger();
        }
    }
}
```

**修复的Bug**：
- ❌ 之前：TIM15回调中禁用TIM6（错误）
- ✅ 现在：TIM15回调中禁用TIM15（正确）

### 6. 取消心电同步时停止所有定时器

```c
void ECG_SYNC_Cancel(void)
{
    g_ecg_sync.state = SYNC_STATUS_IDLE;
    __HAL_TIM_DISABLE(&htim4);
    
    /* 【修改】停止所有定时器 */
    __HAL_TIM_DISABLE(&htim6);
    __HAL_TIM_DISABLE(&htim7);
    __HAL_TIM_DISABLE(&htim15);
}
```

### 7. BSP层中断处理函数

**位置**：`drivers/bsp/stm32/hal/bsp_tim.c`

#### 添加TIM7和TIM15的中断初始化
```c
void HAL_TIM_Base_MspInit(TIM_HandleTypeDef* tim_baseHandle)
{
    // ... TIM4, TIM6 ...
    
    else if (tim_baseHandle->Instance == TIM7) {
        __HAL_RCC_TIM7_CLK_ENABLE();
        HAL_NVIC_SetPriority(TIM7_IRQn, 1, 0);
        HAL_NVIC_EnableIRQ(TIM7_IRQn);
    } else if (tim_baseHandle->Instance == TIM15) {
        __HAL_RCC_TIM15_CLK_ENABLE();
        HAL_NVIC_SetPriority(TIM15_IRQn, 1, 0);
        HAL_NVIC_EnableIRQ(TIM15_IRQn);
    }
}
```

#### 添加TIM7和TIM15的中断处理函数
```c
void TIM7_IRQHandler(void)
{
    HAL_TIM_IRQHandler(&htim7);
}

void TIM15_IRQHandler(void)
{
    HAL_TIM_IRQHandler(&htim15);
}
```

#### 修复重复定义
- ❌ 之前：`TIM6_DAC_IRQHandler()` 重复定义了3次
- ✅ 现在：只保留一个定义，并添加TIM7和TIM15的处理函数

## 工作流程

### 设置参数阶段
```
pulse_engine_set_sync_param()
    ↓
配置TIM7（触发延时定时器）
    ↓
配置TIM15（停止时间定时器）
    ↓
完成（定时器已配置好，但未启动）
```

### 运行阶段

#### 第一次触发
```
检测到R波
    ↓
关闭TIM4（停止R波检测）
    ↓
启动TIM7（触发延时定时器）
    ↓
TIM7超时 → 启动脉冲输出
    ↓
脉冲输出完成
    ↓
启动TIM4（恢复R波检测）
    ↓
启动TIM15（停止时间定时器）
    ↓
TIM15超时 → 进入等待间隔
    ↓
检测到R波 → 计数并检查间隔
    ↓
间隔满足 → 启动TIM7（下一轮）
```

## 优势

### 1. 性能优化
- ✅ **预配置**：参数设置时配置好，运行时只需启动/停止
- ✅ **减少配置开销**：避免每次触发都重新配置定时器
- ✅ **降低延迟**：启动定时器更快

### 2. 代码清晰
- ✅ **职责分离**：每个定时器只负责一个任务
- ✅ **易于理解**：TIM6=群间隙，TIM7=触发延时，TIM15=停止时间
- ✅ **易于调试**：可以单独观察每个定时器的工作状态

### 3. 可靠性提升
- ✅ **避免冲突**：三个定时器互不干扰
- ✅ **修复Bug**：修复了TIM15回调中禁用TIM6的错误
- ✅ **状态清晰**：每个定时器的状态独立管理

## 定时器使用总结

| 定时器 | 用途 | 配置时机 | 启动时机 | 停止时机 |
|--------|------|----------|----------|----------|
| **TIM6** | 群间隙定时器 | 每次群间隙前 | 群输出完成后 | 群间隙超时 |
| **TIM7** | 触发延时定时器 | 设置参数时 | 检测到R波后 | 延时到达 |
| **TIM15** | 停止时间定时器 | 设置参数时 | 脉冲输出完成后 | 停止时间到达 |

## 注意事项

1. **参数设置时机**
   - 必须在非运行状态下设置参数
   - 设置参数时会立即配置TIM7和TIM15

2. **定时器启动**
   - 启动前需要清零计数器：`__HAL_TIM_SET_COUNTER(&htimX, 0U)`
   - 确保定时器从0开始计数

3. **定时器停止**
   - 取消心电同步时需要停止所有定时器
   - 避免定时器在不需要时继续运行

4. **中断优先级**
   - TIM6、TIM7、TIM15都设置为优先级1
   - 确保定时器中断能及时响应

## 测试建议

1. **验证定时器配置**
   - 设置参数后，检查TIM7和TIM15的PSC和ARR是否正确
   - 验证定时器未启动（ENABLE位为0）

2. **验证定时器启动**
   - 检测到R波后，验证TIM7是否启动
   - 脉冲输出完成后，验证TIM15是否启动

3. **验证定时器停止**
   - 延时到达后，验证TIM7是否停止
   - 停止时间到达后，验证TIM15是否停止
   - 取消心电同步时，验证所有定时器是否停止

4. **验证中断处理**
   - TIM7中断是否触发脉冲输出
   - TIM15中断是否进入等待间隔状态
   - TIM6中断是否启动下一组脉冲

## 总结

通过这次重构：
- ✅ 实现了三个定时器的独立使用
- ✅ 在参数设置时预配置定时器
- ✅ 修复了TIM15回调中的bug
- ✅ 提高了代码的可读性和可维护性
- ✅ 优化了运行时性能

重构后的代码更加清晰、高效、可靠！

