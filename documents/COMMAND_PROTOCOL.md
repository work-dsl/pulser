# 自定义协议命令说明文档

## 1. 协议格式说明

### 1.1 帧结构

协议帧分为两种类型：**命令帧**和**应答帧**。

#### 1.1.1 命令帧结构

命令帧用于主机向从机发送命令，结构如下：

```
+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|  帧头  |  长度  |  设备  |  命令  |  模块  |  数据  |  CRC16 |  帧尾  |
|  (1B)  |  (2B)  |  (1B)  |  (1B)  |  (1B)  | (变长) |  (2B)  |  (1B)  |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|  0xFA  | LEN_LE |  DEV   |  CMD   |  MOD   |  DATA  | CRC_LE |  0x0D  |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+
```

**字段说明：**

- **帧头 (HEAD)**: 固定为 `0xFA` (1字节)
- **长度 (LEN)**: 整帧长度（含头尾），小端序 (2字节)
- **设备地址 (DEV)**: 目标设备地址 (1字节)
  - 从机设备地址：`0x03`
- **命令码 (CMD)**: 命令类型 (1字节)
- **模块标识 (MOD)**: 模块地址 (1字节)
  - 从机模块地址：`0x02`
- **数据载荷 (DATA)**: 命令数据，可变长度
- **CRC16**: 校验值，从长度字段开始计算到数据载荷结束，使用Modbus CRC16算法，小端序 (2字节)
- **帧尾 (TAIL)**: 固定为 `0x0D` (1字节)

#### 1.1.2 应答帧结构

应答帧用于从机向主机回复命令执行结果，结构如下：

```
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|  帧头  |  长度  |  设备  |  命令  |  模块  |  应答  |  数据  |  CRC16 |  帧尾  |
|  (1B)  |  (2B)  |  (1B)  |  (1B)  |  (1B)  |  (1B)  | (变长) |  (2B)  |  (1B)  |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|  0xFA  | LEN_LE |  DEV   |  CMD   |  MOD   |  ACK   |  DATA  | CRC_LE |  0x0D  |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
```

**字段说明：**

- **帧头 (HEAD)**: 固定为 `0xFA` (1字节)
- **长度 (LEN)**: 整帧长度（含头尾），小端序 (2字节)
- **设备地址 (DEV)**: 设备地址 (1字节)
  - 从机设备地址：`0x03`
- **命令码 (CMD)**: 对应的命令码 (1字节)
- **模块标识 (MOD)**: 模块地址 (1字节)
  - 从机模块地址：`0x02`
- **应答码 (ACK)**: 应答码，表示命令执行结果 (1字节)
  - `0x00`: ACK_OK（操作成功）
  - 其他值：错误码（见响应码定义）
- **数据载荷 (DATA)**: 响应数据，可变长度（可为空）
- **CRC16**: 校验值，从长度字段开始计算到数据载荷结束，使用Modbus CRC16算法，小端序 (2字节)
- **帧尾 (TAIL)**: 固定为 `0x0D` (1字节)

**注意：** 应答帧必须包含应答码字段，即使没有数据载荷，应答码也必须存在。

### 1.2 帧长度计算

#### 1.2.1 命令帧长度

- **最小帧长度**: 9字节（无数据载荷）
- **最大帧长度**: 64字节
- **固定开销**: 9字节（1+2+1+1+1+2+1）
- **数据载荷最大长度**: 55字节（64-9）

#### 1.2.2 应答帧长度

- **最小帧长度**: 10字节（无数据载荷，仅应答码）
- **最大帧长度**: 64字节
- **固定开销**: 10字节（1+2+1+1+1+1+2+1）
- **数据载荷最大长度**: 54字节（64-10）

**注意：** 应答帧的固定开销比命令帧多1字节（应答码字段）。

### 1.3 CRC16计算

- **计算范围**: 从长度字段（偏移1）开始，到数据载荷结束
- **算法**: Modbus CRC16
- **字节序**: 小端序（低字节在前）

### 1.4 字节序

协议中所有多字节字段均采用**小端序（Little Endian）**：
- 长度字段：低字节在前
- CRC16：低字节在前
- 所有数据字段中的多字节数值：低字节在前

## 2. 响应码定义

### 2.1 ACK响应码

| 响应码 | 值 | 说明 |
|--------|-----|------|
| ACK_OK | 0x00 | 操作执行成功 |
| ACK_ERR_UNKNOWN | 0x01 | 未知错误 |
| ACK_ERR_LEN_FIELD | 0x02 | 长度字段超限（过大或过小） |
| ACK_ERR_CHECKSUM | 0x03 | 校验错误 |
| ACK_ERR_TAIL | 0x04 | 帧尾不匹配 |
| ACK_ERR_BUF_TOO_SMALL | 0x05 | 帧接收缓冲区过小 |
| ACK_ERR_TIMEOUT | 0x06 | 接收超时 |
| ACK_ERR_DEV_ADDR | 0x11 | 设备地址错误 |
| ACK_ERR_MODULE_ADDR | 0x12 | 模块地址错误 |
| ACK_ERR_DATA_INVALID_PARAM | 0x13 | 数据参数无效 |
| ACK_ERR_UNSUP_CMD | 0x14 | 不支持的命令 |
| ACK_ERR_BUSY | 0x15 | 操作正忙 |
| ACK_ERR_OPERATE_ABNORMAL | 0x16 | 操作异常 |
| ACK_ERR_MODE_ABNORMAL | 0x17 | 模式异常 |
| ACK_ERR_OPERATE_INVALID | 0x18 | 操作无效 |
| ACK_ERR_MODULE_LOCK | 0x19 | 模块锁定 |
| ACK_ERR_SYSTEM_LOCK | 0x20 | 系统锁定 |
| ACK_IN_PROGERESS | 0x80 | 已接受，正在执行（针对耗时类命令） |

### 2.2 响应帧格式

响应帧格式与命令帧不同，应答码位于帧结构中（模块地址之后），而不是在数据载荷中。

应答帧结构：
```
+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|  帧头  |  长度  |  设备  |  命令  |  模块  |  应答  |  数据  |  CRC16 |  帧尾  |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+
```

- **应答码 (ACK)**: 位于帧结构中，模块地址之后（1字节）
- **数据载荷 (DATA)**: 响应数据（可选，根据命令而定）

**重要说明：**
- 应答帧的应答码字段是帧结构的一部分，不是数据载荷的一部分
- 即使没有响应数据，应答码字段也必须存在
- 数据载荷中只包含实际的响应数据，不包含应答码

### 2.3 应答帧处理逻辑

#### 2.3.1 帧解析错误时的应答

当从机接收到命令帧后，如果发生帧解析错误（如校验错误、长度错误等），从机会发送错误应答帧。

**错误应答帧格式：**
- **命令码**: 固定为 `0x2F` (CMD_FRAME_PARSER_ERR_ACK)
- **应答码**: 对应的错误码（如 ACK_ERR_CHECKSUM、ACK_ERR_LEN_FIELD 等）
- **数据载荷**: 无

**示例：**

假设主机发送命令帧：
```
FA 09 00 03 AA 02 [CRC16低] [CRC16高] 0D
```

如果发生校验错误，从机回复：
```
FA 0A 00 03 2F 02 03 [CRC16低] [CRC16高] 0D
```

其中：
- `2F`: 命令码（帧解析错误应答）
- `03`: 应答码（ACK_ERR_CHECKSUM）

#### 2.3.2 帧解析成功时的应答

当从机成功解析命令帧后，根据操作耗时情况，采用不同的应答策略：

**情况1：短时间操作（立即完成）**

对于能在较短时间内完成的操作，从机会先执行操作，然后发送应答帧。

**应答帧格式：**
- **命令码**: 原命令码（与接收到的命令码相同）
- **应答码**: 操作结果（ACK_OK 或相应的错误码）
- **数据载荷**: 根据命令定义，可能包含响应数据

**示例：**

假设主机发送命令帧：
```
FA 09 00 03 AA 02 [CRC16低] [CRC16高] 0D
```

操作成功时，从机回复：
```
FA 0A 00 03 AA 02 00 [CRC16低] [CRC16高] 0D
```

其中：
- `AA`: 命令码（与原命令码相同）
- `00`: 应答码（ACK_OK）
- 无数据载荷

操作失败时（如操作正忙），从机回复：
```
FA 0A 00 03 AA 02 15 [CRC16低] [CRC16高] 0D
```

其中：
- `AA`: 命令码（与原命令码相同）
- `15`: 应答码（ACK_ERR_BUSY）

**情况2：长时间操作（需要等待）**

对于需要较长时间完成的操作，从机会先发送一个"正在执行"的应答帧，操作完成后再发送最终应答帧。

**第一步：立即回复"正在执行"**
```
FA 0A 00 03 AA 02 80 [CRC16低] [CRC16高] 0D
```

其中：
- `AA`: 命令码（与原命令码相同）
- `80`: 应答码（ACK_IN_PROGERESS）

**第二步：操作完成后发送最终应答**

操作成功时：
```
FA 0A 00 03 AA 02 00 [CRC16低] [CRC16高] 0D
```

操作失败时：
```
FA 0A 00 03 AA 02 [错误码] [CRC16低] [CRC16高] 0D
```

**注意：**
- 长时间操作的命令包括：系统自检（CMD_CTRL_SELF_CHECK）、在线升级（CMD_CTRL_IAP）等
- 最终应答帧的命令码仍为原命令码，应答码为最终操作结果

## 3. 通用命令（0x01-0x0C, 0x2F）

### 3.1 上电握手 (CMD_HAND_SHAKE = 0x01)

**功能说明：** 用于主机与从机建立通信连接。从机在未握手状态下会周期性广播握手请求，收到主机的握手指令后进入活动状态。

**发送帧（主机→从机）：**

```
FA 09 00 03 01 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA 0A 00 03 01 02 00 [CRC16低] [CRC16高] 0D
```

**应答帧结构：**
- `FA`: 帧头
- `0A 00`: 长度=10（小端）
- `03`: 设备地址
- `01`: 命令码（握手）
- `02`: 模块地址
- `00`: 应答码（ACK_OK）
- `[CRC16低] [CRC16高]`: CRC16校验
- `0D`: 帧尾

**数据载荷：** 无（仅应答码）

**应答说明：**
- 从机收到握手命令后，立即回复ACK_OK
- 如果从机处于等待握手状态，收到握手后切换到活动状态

---

### 3.2 查询软件版本 (CMD_GET_SOFTWARE_VERSION = 0x02)

**功能说明：** 查询从机的软件版本信息。

**发送帧（主机→从机）：**

```
FA 09 00 03 02 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA 0E 00 03 02 02 00 V1.0.0 [CRC16低] [CRC16高] 0D
```

**应答帧结构：**
- `FA`: 帧头
- `0E 00`: 长度=14（小端）
- `03`: 设备地址
- `02`: 命令码（查询软件版本）
- `02`: 模块地址
- `00`: 应答码（ACK_OK）
- `V1.0.0`: 数据载荷（软件版本字符串，ASCII码）
- `[CRC16低] [CRC16高]`: CRC16校验
- `0D`: 帧尾

**数据载荷：**
- `V1.0.0`: 软件版本字符串（ASCII码，长度可变）

**应答说明：**
- 成功时返回ACK_OK和版本字符串
- 失败时返回相应的错误码

---

### 3.3 设置硬件版本 (CMD_SET_HARDWARE_VERSION = 0x03)

**功能说明：** 设置从机的硬件版本信息。

**发送帧（主机→从机）：**

```
FA 0F 00 03 03 02 HW_V1.0 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `HW_V1.0`: 硬件版本字符串（ASCII码，最大长度由系统限制）

**接收帧（从机→主机）：**

```
FA 0A 00 03 03 02 00 [CRC16低] [CRC16高] 0D
```

**应答帧结构：**
- `00`: 应答码（ACK_OK）

**数据载荷：** 无（仅应答码）

**应答说明：**
- 成功时返回ACK_OK
- 参数无效时返回ACK_ERR_DATA_INVALID_PARAM
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

---

### 3.4 查询硬件版本 (CMD_GET_HARDWARE_VERSION = 0x04)

**功能说明：** 查询从机的硬件版本信息。

**发送帧（主机→从机）：**

```
FA 09 00 03 04 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA 0E 00 03 04 02 00 HW_V1.0 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK
- `HW_V1.0`: 硬件版本字符串（ASCII码，长度可变）

**应答说明：**
- 成功时返回ACK_OK和版本字符串
- 失败时返回相应的错误码

---

### 3.5 设置序列号 (CMD_SET_SERIAL_NUMBER = 0x05)

**功能说明：** 设置从机的序列号信息。

**发送帧（主机→从机）：**

```
FA 12 00 03 05 02 SN12345678 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `SN12345678`: 序列号字符串（ASCII码，最大长度由系统限制）

**接收帧（从机→主机）：**

```
FA 0A 00 03 05 02 00 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK

**应答说明：**
- 成功时返回ACK_OK
- 参数无效时返回ACK_ERR_DATA_INVALID_PARAM
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

---

### 3.6 查询序列号 (CMD_GET_SERIAL_NUMBER = 0x06)

**功能说明：** 查询从机的序列号信息。

**发送帧（主机→从机）：**

```
FA 09 00 03 06 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA 12 00 03 06 02 00 SN12345678 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK
- `SN12345678`: 序列号字符串（ASCII码，长度可变）

**应答说明：**
- 成功时返回ACK_OK和序列号字符串
- 失败时返回相应的错误码

---

### 3.7 系统复位控制 (CMD_CTRL_SOFT_RESET = 0x07)

**功能说明：** 控制从机执行软件复位。

**发送帧（主机→从机）：**

```
FA 09 00 03 07 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA 0A 00 03 07 02 00 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK

**应答说明：**
- 从机收到命令后立即回复ACK_OK，然后执行复位
- 复位后从机将重新进入等待握手状态

---

### 3.8 系统自检控制 (CMD_CTRL_SELF_CHECK = 0x08)

**功能说明：** 控制从机执行系统自检（耗时操作）。此命令需要较长时间完成，采用两步应答机制。

**发送帧（主机→从机）：**

```
FA 09 00 03 08 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**第一步应答帧（从机→主机，立即回复）：**

```
FA 0A 00 03 08 02 80 [CRC16低] [CRC16高] 0D
```

**应答帧结构：**
- `08`: 命令码（系统自检）
- `80`: 应答码（ACK_IN_PROGERESS，正在执行）

**数据载荷：** 无

**第二步应答帧（从机→主机，操作完成后）：**

操作成功时：
```
FA 0A 00 03 08 02 00 [CRC16低] [CRC16高] 0D
```

操作失败时：
```
FA 0A 00 03 08 02 [错误码] [CRC16低] [CRC16高] 0D
```

**应答说明：**
- 从机收到命令后立即回复 ACK_IN_PROGERESS（0x80），表示已接受命令并开始执行
- 自检完成后，从机发送最终应答帧，命令码仍为 `0x08`，应答码为操作结果（ACK_OK 或错误码）
- 这是长时间操作的典型应答模式

---

### 3.9 低功耗控制 (CMD_CTRL_LOW_POWER_MODE = 0x09)

**功能说明：** 控制从机进入或退出低功耗模式。

**发送帧（主机→从机）：**

```
FA 09 00 03 09 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA 0A 00 03 09 02 00 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK

**应答说明：**
- 成功时返回ACK_OK
- 失败时返回相应的错误码

---

### 3.10 启动在线升级 (CMD_CTRL_IAP = 0x0A)

**功能说明：** 控制从机启动在线升级（耗时操作）。此命令需要较长时间完成，采用两步应答机制。

**发送帧（主机→从机）：**

```
FA 09 00 03 0A 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**第一步应答帧（从机→主机，立即回复）：**

```
FA 0A 00 03 0A 02 80 [CRC16低] [CRC16高] 0D
```

**应答帧结构：**
- `0A`: 命令码（启动在线升级）
- `80`: 应答码（ACK_IN_PROGERESS，正在执行）

**数据载荷：** 无

**第二步应答帧（从机→主机，操作完成后）：**

操作成功时：
```
FA 0A 00 03 0A 02 00 [CRC16低] [CRC16高] 0D
```

操作失败时：
```
FA 0A 00 03 0A 02 [错误码] [CRC16低] [CRC16高] 0D
```

**应答说明：**
- 从机收到命令后立即回复 ACK_IN_PROGERESS（0x80），表示已接受命令并开始执行
- 升级完成后，从机发送最终应答帧，命令码仍为 `0x0A`，应答码为操作结果（ACK_OK 或错误码）
- 这是长时间操作的典型应答模式

---

### 3.11 控制上传模式 (CMD_CTRL_UPLOAD_MODE = 0x0B)

**功能说明：** 控制从机的数据上传模式。

**发送帧（主机→从机）：**

```
FA 09 00 03 0B 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA 0A 00 03 0B 02 00 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK

**应答说明：**
- 成功时返回ACK_OK
- 失败时返回相应的错误码

---

### 3.12 状态上传 (CMD_STATUS_UPLOAD = 0x0C)

**功能说明：** 从机主动上报状态信息（非应答型命令）。

**发送帧（从机→主机）：**

```
FA 11 00 03 0C 02 [状态数据] [CRC16低] [CRC16高] 0D
```

**数据载荷：** 状态数据（格式根据具体状态类型而定）

**接收帧：** 无（主机不回复）

**应答说明：**
- 此命令为从机主动上报，主机不回复
- 可用于上报过流信息、脉冲完成状态等

---

### 3.13 帧解析错误应答 (CMD_FRAME_PARSER_ERR_ACK = 0x2F)

**功能说明：** 从机在帧解析错误时发送的错误应答。此命令码专门用于帧解析阶段的错误响应。

**发送帧（从机→主机）：**

```
FA 0A 00 03 2F 02 [错误码] [CRC16低] [CRC16高] 0D
```

**应答帧结构：**
- `FA`: 帧头
- `0A 00`: 长度=10（小端）
- `03`: 设备地址
- `2F`: 命令码（帧解析错误应答）
- `02`: 模块地址
- `[错误码]`: 应答码（帧解析错误码）
- `[CRC16低] [CRC16高]`: CRC16校验
- `0D`: 帧尾

**应答码说明：**
- `0x02`: ACK_ERR_LEN_FIELD（长度字段超限）
- `0x03`: ACK_ERR_CHECKSUM（校验错误）
- `0x04`: ACK_ERR_TAIL（帧尾不匹配）
- `0x05`: ACK_ERR_BUF_TOO_SMALL（缓冲区过小）
- `0x06`: ACK_ERR_TIMEOUT（接收超时）

**数据载荷：** 无

**接收帧：** 无（主机不回复）

**应答说明：**
- 此命令为从机主动上报帧解析错误，主机不回复
- 当从机无法正确解析接收到的命令帧时，使用此命令码发送错误应答
- 错误应答帧的命令码固定为 `0x2F`，与原命令码无关

**示例：**

假设主机发送命令帧（校验错误）：
```
FA 09 00 03 AA 02 [错误的CRC] 0D
```

从机回复：
```
FA 0A 00 03 2F 02 03 [CRC16低] [CRC16高] 0D
```

其中 `03` 表示 ACK_ERR_CHECKSUM（校验错误）

---

## 4. 从机专有命令（0x30-0x3A）

### 4.1 控制脉冲序列输出 (CMD_CTRL_PULSE_ENGINE_START = 0x30)

**功能说明：** 控制脉冲序列的启动或停止。

**发送帧（主机→从机）：**

```
FA 0A 00 03 30 02 [控制码] [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `[控制码]` (1字节):
  - `0x00`: 停止脉冲输出
  - `0x01`: 启动脉冲输出

**接收帧（从机→主机）：**

```
FA 0A 00 03 30 02 00 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK

**应答说明：**
- 成功时返回ACK_OK
- 参数无效时返回ACK_ERR_DATA_INVALID_PARAM
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

**示例：**

启动脉冲输出：
```
FA 0A 00 03 30 02 01 [CRC16低] [CRC16高] 0D
```

停止脉冲输出：
```
FA 0A 00 03 30 02 00 [CRC16低] [CRC16高] 0D
```

---

### 4.2 获取脉冲序列输出状态 (CMD_GET_PULSE_ENGINE_STATUS = 0x31)

**功能说明：** 查询脉冲序列输出的当前状态。

**发送帧（主机→从机）：**

```
FA 09 00 03 31 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA 0E 00 03 31 02 00 [模式] [状态] [次数低] [次数高] [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK
- `[模式]` (1字节):
  - `0x00`: PULSE_MODE_NORMAL（正常模式）
  - `0x01`: PULSE_MODE_ECG_SYNC（心电同步触发模式）
- `[状态]` (1字节):
  - `0x00`: PULSE_STATUS_IDLE（空闲状态）
  - `0x01`: PULSE_STATUS_RUNNING（运行状态）
  - `0x02`: PULSE_STATUS_COMPLETED（完成状态）
  - `0x03`: PULSE_STATUS_ERROR（错误状态）
- `[次数低]` (1字节): 输出次数低字节
- `[次数高]` (1字节): 输出次数高字节（小端序）

**应答说明：**
- 成功时返回ACK_OK和状态信息
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

**示例：**

查询状态（正常模式，运行中，已输出5次）：
```
接收: FA 0E 00 03 31 02 00 00 01 05 00 [CRC16低] [CRC16高] 0D
```

---

### 4.3 设置脉冲序列输出模式 (CMD_SET_PULSE_ENGINE_TRIGGER_MODE = 0x32)

**功能说明：** 设置脉冲序列输出模式：正常模式或心电同步触发模式。

**发送帧（主机→从机）：**

```
FA 0A 00 03 32 02 [模式] [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `[模式]` (1字节):
  - `0x00`: PULSE_MODE_NORMAL（正常模式）
  - `0x01`: PULSE_MODE_ECG_SYNC（心电同步触发模式）

**接收帧（从机→主机）：**

```
FA 0A 00 03 32 02 00 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK

**应答说明：**
- 成功时返回ACK_OK
- 参数无效时返回ACK_ERR_DATA_INVALID_PARAM
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

**示例：**

设置为心电同步触发模式：
```
FA 0A 00 03 32 02 01 [CRC16低] [CRC16高] 0D
```

---

### 4.4 获取脉冲序列输出模式 (CMD_GET_PULSE_ENGINE_TRIGGER_MODE = 0x33)

**功能说明：** 查询脉冲序列输出的当前模式。

**发送帧（主机→从机）：**

```
FA 09 00 03 33 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA 0A 00 03 33 02 00 [模式] [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK
- `[模式]` (1字节):
  - `0x00`: PULSE_MODE_NORMAL（正常模式）
  - `0x01`: PULSE_MODE_ECG_SYNC（心电同步触发模式）

**应答说明：**
- 成功时返回ACK_OK和模式值
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

---

### 4.5 设置脉冲序列参数 (CMD_SET_PULSE_ENGINE_PARAMETERS = 0x34)

**功能说明：** 设置脉冲序列参数。参数结构体定义如下：

```c
typedef struct pulse_sequence {
    uint8_t  num_of_group;          // 群个数，范围：1-20
    uint8_t  group_num;              // 群编号，范围：1-20
    uint16_t group_gap;              // 群间隙，范围：50-10000ms
    uint16_t train_per_group;        // 每群脉冲串数量，范围：1-300
    uint16_t train_gap;              // 脉冲串间隙，范围：1-100ms
    uint16_t periods_per_train;     // 每串脉冲周期数，范围：1-300
    uint16_t np_gap;                 // 负-正脉冲间隙，单位：ns
    uint16_t pos_pw;                 // 正脉宽，单位：ns
    uint16_t pn_gap;                 // 正-负脉冲间隙，单位：ns
    uint16_t neg_pw;                 // 负脉宽，单位：ns，0表示单极性
} pulse_params_t;
```

**发送帧（主机→从机）：**

```
FA 17 00 03 34 02 [参数数据20字节] [CRC16低] [CRC16高] 0D
```

**数据载荷：** `pulse_params_t`结构体的二进制数据（20字节，小端序）

**数据格式（小端序）：**
```
字节偏移 | 字段              | 大小 | 说明
--------|-------------------|------|------------------
0       | num_of_group      | 1    | 群个数
1       | group_num         | 1    | 群编号
2-3     | group_gap         | 2    | 群间隙(ms)
4-5     | train_per_group   | 2    | 每群脉冲串数量
6-7     | train_gap         | 2    | 脉冲串间隙(ms)
8-9     | periods_per_train | 2    | 每串脉冲周期数
10-11   | np_gap            | 2    | 负-正脉冲间隙(ns)
12-13   | pos_pw            | 2    | 正脉宽(ns)
14-15   | pn_gap            | 2    | 正-负脉冲间隙(ns)
16-17   | neg_pw            | 2    | 负脉宽(ns)
```

**接收帧（从机→主机）：**

```
FA 0A 00 03 34 02 00 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK

**应答说明：**
- 成功时返回ACK_OK
- 参数长度不正确时返回ACK_ERR_DATA_INVALID_PARAM
- 参数值无效时返回ACK_ERR_DATA_INVALID_PARAM
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

**示例：**

设置参数（群个数=2，群编号=1，群间隙=100ms，每群脉冲串数=10，串间隙=5ms，每串周期数=20，np_gap=1000ns，pos_pw=500ns，pn_gap=1000ns，neg_pw=500ns）：
```
发送: FA 17 00 03 34 02 
      02 01                    // num_of_group=2, group_num=1
      64 00                    // group_gap=100 (小端)
      0A 00                    // train_per_group=10
      05 00                    // train_gap=5
      14 00                    // periods_per_train=20
      E8 03                    // np_gap=1000 (小端)
      F4 01                    // pos_pw=500 (小端)
      E8 03                    // pn_gap=1000 (小端)
      F4 01                    // neg_pw=500 (小端)
      [CRC16低] [CRC16高] 0D
```

---

### 4.6 获取脉冲序列参数 (CMD_GET_PULSE_ENGINE_PARAMETERS = 0x35)

**功能说明：** 查询当前配置的所有脉冲序列参数。

**发送帧（主机→从机）：**

```
FA 09 00 03 35 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA [长度] 00 03 35 02 00 [参数数据N*20字节] [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK
- `[参数数据]`: 多个`pulse_params_t`结构体的二进制数据（每个20字节，小端序）
  - 返回的参数数量 = `num_of_group`（第一个参数的群个数字段）

**应答说明：**
- 成功时返回ACK_OK和所有参数数据
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

**示例：**

查询参数（假设有2组参数）：
```
接收: FA 2D 00 03 35 02 00 
      [第1组参数20字节]
      [第2组参数20字节]
      [CRC16低] [CRC16高] 0D
```

---

### 4.7 设置心电同步触发参数 (CMD_SET_ECG_SYNC_TRIGGER_PARAMETERS = 0x36)

**功能说明：** 设置心电同步触发参数。参数结构体定义如下：

```c
typedef struct {
    uint16_t trigger_delay_ms;  // 触发输出延时，单位：ms，范围：0-300
    uint16_t stop_delay_ms;     // 停止时间，单位：ms，范围：200-2000
    uint16_t interval_R;        // R波间隔个数，范围：0-30
    uint16_t repeat_count;      // 连续触发次数，范围：1-300
} ecg_sync_cfg_t;
```

**发送帧（主机→从机）：**

```
FA 0F 00 03 36 02 [参数数据8字节] [CRC16低] [CRC16高] 0D
```

**数据载荷：** `ecg_sync_cfg_t`结构体的二进制数据（8字节，小端序）

**数据格式（小端序）：**
```
字节偏移 | 字段              | 大小 | 说明
--------|-------------------|------|------------------
0-1     | trigger_delay_ms  | 2    | 触发输出延时(ms)
2-3     | stop_delay_ms     | 2    | 停止时间(ms)
4-5     | interval_R        | 2    | R波间隔个数
6-7     | repeat_count      | 2    | 连续触发次数
```

**接收帧（从机→主机）：**

```
FA 0A 00 03 36 02 00 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK

**应答说明：**
- 成功时返回ACK_OK
- 参数长度不正确时返回ACK_ERR_DATA_INVALID_PARAM
- 参数值无效时返回ACK_ERR_DATA_INVALID_PARAM
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

**示例：**

设置参数（触发延时=50ms，停止时间=500ms，R波间隔=2，重复次数=10）：
```
发送: FA 0F 00 03 36 02 
      32 00                    // trigger_delay_ms=50 (小端)
      F4 01                    // stop_delay_ms=500 (小端)
      02 00                    // interval_R=2 (小端)
      0A 00                    // repeat_count=10 (小端)
      [CRC16低] [CRC16高] 0D
```

---

### 4.8 获取心电同步触发参数 (CMD_GET_ECG_SYNC_TRIGGER_PARAMETERS = 0x37)

**功能说明：** 查询当前配置的心电同步触发参数。

**发送帧（主机→从机）：**

```
FA 09 00 03 37 02 [CRC16低] [CRC16高] 0D
```

**数据载荷：** 无

**接收帧（从机→主机）：**

```
FA 11 00 03 37 02 00 [参数数据8字节] [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK
- `[参数数据]`: `ecg_sync_cfg_t`结构体的二进制数据（8字节，小端序）

**应答说明：**
- 成功时返回ACK_OK和参数数据
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

**示例：**

查询参数（触发延时=50ms，停止时间=500ms，R波间隔=2，重复次数=10）：
```
接收: FA 11 00 03 37 02 00 
      32 00                    // trigger_delay_ms=50 (小端)
      F4 01                    // stop_delay_ms=500 (小端)
      02 00                    // interval_R=2 (小端)
      0A 00                    // repeat_count=10 (小端)
      [CRC16低] [CRC16高] 0D
```

---

### 4.9 设置过流检测的电压阈值 (CMD_SET_OCD_VOLTAGE_THRESHOLD = 0x38)

**功能说明：** 设置过流检测（OCD）的电压阈值。

**发送帧（主机→从机）：**

```
FA 0C 00 03 38 02 [通道] [电压低] [电压高] [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `[通道]` (1字节):
  - `0x00`: 通道1（ADC1/COMP3，使用DAC1）
  - `0x01`: 通道2（ADC2/COMP1，使用DAC3）
- `[电压低]` (1字节): 电压阈值低字节（单位：mV）
- `[电压高]` (1字节): 电压阈值高字节（小端序）

**接收帧（从机→主机）：**

```
FA 0A 00 03 38 02 00 [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `00`: ACK_OK

**应答说明：**
- 成功时返回ACK_OK
- 参数长度不正确时返回ACK_ERR_DATA_INVALID_PARAM
- 通道号无效时返回ACK_ERR_DATA_INVALID_PARAM
- 操作异常时返回ACK_ERR_OPERATE_ABNORMAL

**示例：**

设置通道1的电压阈值为1650mV：
```
发送: FA 0C 00 03 38 02 
      00                    // 通道1
      72 06                 // 1650 = 0x0672 (小端)
      [CRC16低] [CRC16高] 0D
```

---

### 4.10 获取过流检测的电压阈值 (CMD_GET_OCD_VOLTAGE_THRESHOLD = 0x39)

**功能说明：** 查询指定通道的过流检测电压阈值。

**发送帧（主机→从机）：**

```
FA 0A 00 03 39 02 [通道] [CRC16低] [CRC16高] 0D
```

**数据载荷：**
- `[通道]` (1字节):
  - `0x00`: 通道1
  - `0x01`: 通道2

**接收帧（从机→主机）：**

```
FA 0D 00 03 39 02 00 [电压低] [电压高] [CRC16低] [CRC16高] 0D
```

**应答帧结构：**
- `39`: 命令码（获取过流检测电压阈值）
- `00`: 应答码（ACK_OK）

**数据载荷：**
- `[电压低]` (1字节): 电压阈值低字节（单位：mV）
- `[电压高]` (1字节): 电压阈值高字节（小端序）

**应答说明：**
- 成功时返回ACK_OK和电压阈值
- 参数长度不正确时返回ACK_ERR_DATA_INVALID_PARAM
- 通道号无效时返回ACK_ERR_DATA_INVALID_PARAM

**示例：**

查询通道1的电压阈值（假设为1650mV）：
```
接收: FA 0D 00 03 39 02 00 
      72 06                 // 1650 = 0x0672 (小端)
      [CRC16低] [CRC16高] 0D
```

---

### 4.11 脉冲序列输出完成状态上报 (CMD_PULSE_ENGINE_STATUS_UPLOAD = 0x3A)

**功能说明：** 从机主动上报脉冲序列输出完成状态（非应答型命令）。

**发送帧（从机→主机）：**

```
FA [长度] 00 03 3A 02 [状态数据] [CRC16低] [CRC16高] 0D
```

**数据载荷：** 状态数据（格式：`模式字符串|状态字符串|次数(2字节)`）

**数据格式：**
- `模式字符串`: ASCII字符串，"Normal"或"SYNC"
- `|`: 分隔符（0x7C）
- `状态字符串`: ASCII字符串，"OK"、"ERROR"或"RUNNING"
- `|`: 分隔符（0x7C）
- `次数低` (1字节): 输出次数低字节
- `次数高` (1字节): 输出次数高字节（小端序）

**接收帧：** 无（主机不回复）

**应答说明：**
- 此命令为从机主动上报，主机不回复
- 在脉冲输出完成时自动发送

**示例：**

上报状态（正常模式，完成，输出5次）：
```
发送: FA 12 00 03 3A 02 
      4E 6F 72 6D 61 6C 7C 4F 4B 7C 05 00
      // "Normal|OK|" + 次数=5 (小端)
      [CRC16低] [CRC16高] 0D
```

---

## 5. 通信流程说明

### 5.1 应答帧处理流程

从机接收到命令帧后的处理流程如下：

```
接收命令帧
   |
   v
帧格式解析
   |
   v
[解析失败] -> 发送错误应答帧 (CMD=0x2F, ACK=错误码)
   |
   v
[解析成功] -> 校验设备地址和模块地址
   |
   v
[地址不匹配] -> 丢弃帧（不回复）
   |
   v
[地址匹配] -> 检查握手状态
   |
   v
[未握手且非握手命令] -> 丢弃帧（不回复）
   |
   v
[已握手或握手命令] -> 判断操作耗时
   |
   +--[短时间操作] -> 执行操作 -> 发送应答帧 (CMD=原命令码, ACK=操作结果)
   |
   +--[长时间操作] -> 发送"正在执行"应答帧 (CMD=原命令码, ACK=0x80)
                      |
                      v
                      执行操作
                      |
                      v
                      发送最终应答帧 (CMD=原命令码, ACK=操作结果)
```

**关键点说明：**

1. **帧解析错误**：
   - 命令码固定为 `0x2F`（CMD_FRAME_PARSER_ERR_ACK）
   - 应答码为对应的解析错误码（如 ACK_ERR_CHECKSUM）
   - 无数据载荷

2. **短时间操作**：
   - 先执行操作，后发送应答帧
   - 命令码为原命令码
   - 应答码为操作结果（ACK_OK 或错误码）

3. **长时间操作**：
   - 先发送 ACK_IN_PROGERESS（0x80）应答帧
   - 操作完成后发送最终应答帧
   - 两次应答帧的命令码均为原命令码

### 5.2 握手流程

1. **从机启动**：从机启动后进入等待握手状态（SLAVE_STATE_WAIT_HANDSHAKE）
2. **从机广播**：从机每1秒广播一次握手请求
3. **主机响应**：主机收到握手请求后，发送握手指令
4. **从机确认**：从机收到握手指令后，回复ACK_OK并进入活动状态（SLAVE_STATE_ACTIVE）
5. **正常通信**：握手完成后，主机和从机可以正常通信

**流程图：**

```
从机启动
   |
   v
等待握手状态
   |
   v
[每1秒] 广播握手请求 (CMD_HAND_SHAKE, 无数据)
   |
   v
主机收到握手请求
   |
   v
主机发送握手指令 (CMD_HAND_SHAKE, 无数据)
   |
   v
从机回复ACK_OK
   |
   v
从机进入活动状态
   |
   v
正常通信
```

### 5.3 命令-响应流程

命令-响应流程已在"应答帧处理流程"中详细说明，这里补充一些细节：

1. **主机发送命令**：主机构建命令帧并发送
2. **从机接收解析**：从机接收帧，解析帧格式，校验CRC
3. **从机处理命令**：从机根据命令码处理命令
4. **从机发送响应**：从机构建响应帧并发送（根据操作耗时采用不同策略）
5. **主机接收响应**：主机接收响应帧，解析并处理

**响应帧命令码规则：**
- **帧解析错误**：命令码为 `0x2F`
- **操作应答**：命令码为原命令码（与接收到的命令码相同）

### 5.3 错误处理

1. **帧解析错误**：
   - 长度字段超限：返回ACK_ERR_LEN_FIELD
   - CRC校验错误：返回ACK_ERR_CHECKSUM
   - 帧尾不匹配：返回ACK_ERR_TAIL
   - 缓冲区过小：返回ACK_ERR_BUF_TOO_SMALL
   - 接收超时：返回ACK_ERR_TIMEOUT

2. **命令处理错误**：
   - 设备地址错误：返回ACK_ERR_DEV_ADDR
   - 模块地址错误：返回ACK_ERR_MODULE_ADDR
   - 参数无效：返回ACK_ERR_DATA_INVALID_PARAM
   - 不支持的命令：返回ACK_ERR_UNSUP_CMD
   - 操作异常：返回ACK_ERR_OPERATE_ABNORMAL

3. **超时重试**：
   - 主机发送命令后，应等待响应
   - 如果超时未收到响应，主机可以重试发送
   - 建议重试次数：3次
   - 建议超时时间：500ms

## 6. 注意事项

1. **字节序**：协议中所有多字节字段均采用小端序
2. **CRC校验**：CRC计算范围从长度字段开始，到数据载荷结束
3. **握手状态**：从机在未握手状态下，只处理握手命令，其他命令将被忽略
4. **耗时命令**：对于耗时操作（如自检、IAP），从机先回复ACK_IN_PROGERESS，完成后应发送ACK_OK
5. **非应答命令**：状态上传类命令（CMD_STATUS_UPLOAD、CMD_PULSE_ENGINE_STATUS_UPLOAD）为从机主动上报，主机不回复
6. **帧长度限制**：最大帧长度为64字节，数据载荷最大长度为55字节
7. **参数验证**：从机会验证所有参数的有效性，无效参数将返回ACK_ERR_DATA_INVALID_PARAM
8. **并发控制**：从机在同一时间只能处理一个命令，建议主机采用请求-响应模式，避免并发发送

## 7. 附录

### 7.1 CRC16计算示例

CRC16使用Modbus算法，计算范围从长度字段开始到数据载荷结束。

**示例：** 计算帧 `FA 09 00 03 01 02 [CRC] 0D` 的CRC16

1. 提取计算范围：`09 00 03 01 02`（从长度字段到数据载荷结束）
2. 使用Modbus CRC16算法计算
3. 将结果以小端序填入CRC字段

### 7.2 常用命令速查表

| 命令码 | 命令名称 | 方向 | 数据长度 | 响应数据长度 |
|--------|----------|------|----------|--------------|
| 0x01 | 上电握手 | 双向 | 0 | 1 (ACK) |
| 0x02 | 查询软件版本 | 主机→从机 | 0 | 1+ (ACK+字符串) |
| 0x03 | 设置硬件版本 | 主机→从机 | 变长 | 1 (ACK) |
| 0x04 | 查询硬件版本 | 主机→从机 | 0 | 1+ (ACK+字符串) |
| 0x05 | 设置序列号 | 主机→从机 | 变长 | 1 (ACK) |
| 0x06 | 查询序列号 | 主机→从机 | 0 | 1+ (ACK+字符串) |
| 0x07 | 系统复位 | 主机→从机 | 0 | 1 (ACK) |
| 0x08 | 系统自检 | 主机→从机 | 0 | 1 (ACK_IN_PROGERESS) |
| 0x09 | 低功耗控制 | 主机→从机 | 0 | 1 (ACK) |
| 0x0A | 启动在线升级 | 主机→从机 | 0 | 1 (ACK_IN_PROGERESS) |
| 0x0B | 控制上传模式 | 主机→从机 | 0 | 1 (ACK) |
| 0x0C | 状态上传 | 从机→主机 | 变长 | 无 |
| 0x2F | 帧解析错误应答 | 从机→主机 | 1 (错误码) | 无 |
| 0x30 | 控制脉冲序列输出 | 主机→从机 | 1 | 1 (ACK) |
| 0x31 | 获取脉冲序列输出状态 | 主机→从机 | 0 | 5 (ACK+状态) |
| 0x32 | 设置脉冲序列输出模式 | 主机→从机 | 1 | 1 (ACK) |
| 0x33 | 获取脉冲序列输出模式 | 主机→从机 | 0 | 2 (ACK+模式) |
| 0x34 | 设置脉冲序列参数 | 主机→从机 | 20 | 1 (ACK) |
| 0x35 | 获取脉冲序列参数 | 主机→从机 | 0 | 1+ (ACK+参数) |
| 0x36 | 设置心电同步触发参数 | 主机→从机 | 8 | 1 (ACK) |
| 0x37 | 获取心电同步触发参数 | 主机→从机 | 0 | 9 (ACK+参数) |
| 0x38 | 设置过流检测电压阈值 | 主机→从机 | 3 | 1 (ACK) |
| 0x39 | 获取过流检测电压阈值 | 主机→从机 | 1 | 3 (ACK+阈值) |
| 0x3A | 脉冲序列输出完成状态上报 | 从机→主机 | 变长 | 无 |

---

**文档版本**: V1.0  
**最后更新**: 2024-12-XX  
**作者**: ZJY

